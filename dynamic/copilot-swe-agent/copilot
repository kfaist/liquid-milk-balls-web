name: Copilot SWE Agent

on:
  workflow_dispatch:
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, synchronize]

jobs:
  copilot-agent:
    runs-on: ubuntu-latest
    # For troubleshooting context, see commit: 0e78775fc8ad43420cea3301c9a5031c8d8a836c
    # Failed job reference: 54299707342
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: OS Compatibility Check
        run: |
          echo "Checking OS compatibility..."
          if [ "$(uname -s)" != "Linux" ]; then
            echo "SHOULD_CONTINUE=false" >> $GITHUB_ENV
            echo "$(uname -s) is not currently supported."
            exit 1
          fi
          echo "OS Check: $(uname -s) - PASSED"
      
      - name: Network Health Check
        run: |
          echo "Checking connectivity to api.githubcopilot.com ..."
          if ! curl -sSf --connect-timeout 10 https://api.githubcopilot.com/healthz > /dev/null; then
            echo "ERROR: cannot reach api.githubcopilot.com. Check firewall/proxy allowlist for Copilot."
            exit 1
          fi
          echo "OK: Copilot API reachable"
      
      - name: Run Copilot Agent with Retries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash .github/scripts/run-copilot-with-retries.sh
      
      - name: Log Job Information
        if: failure()
        run: |
          echo "================================================"
          echo "Job failed. Troubleshooting information:"
          echo "Failed job ID: 54299707342 (original failure)"
          echo "Current job ID: ${{ github.run_id }}"
          echo "Reference commit: 0e78775fc8ad43420cea3301c9a5031c8d8a836c"
          echo "------------------------------------------------"
          echo "Common issues:"
          echo "1. Network connectivity to api.githubcopilot.com blocked"
          echo "2. Transient API errors (retries should help)"
          echo "3. OS compatibility issues (non-Linux runners)"
          echo "================================================"
