<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LiveKit Cloud Publisher</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #0f0;
      font-family: monospace;
      padding: 20px;
    }
    #status {
      background: rgba(0, 255, 0, 0.9);
      color: #000;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin: 20px auto;
    }
    #status h2 { margin: 0 0 10px 0; }
    .step { padding: 5px 0; }
    .success { color: #0a0; font-weight: bold; }
    .error { color: #f00; font-weight: bold; }
    .pending { color: #fa0; }
    #localVideo {
      width: 640px;
      height: 480px;
      background: #222;
      border: 2px solid #0f0;
      display: block;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <div id="status">
    <h2>LiveKit Cloud Camera Publisher</h2>
    <div id="log">Initializing...</div>
  </div>
  <video id="localVideo" autoplay playsinline muted></video>

  <!-- LOCAL LIBRARY -->
  <script src="livekit-client.min.js"></script>
  
  <script>
    const statusDiv = document.getElementById('log');
    const localVideo = document.getElementById('localVideo');
    const LIVEKIT_URL = 'wss://claymation-transcription-l6e51sws.livekit.cloud';
    const ROOM_NAME = 'mirror-echo';
    
    function log(msg, type = '') {
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'pending';
      statusDiv.innerHTML += `<div class="step ${className}">${msg}</div>`;
      console.log(msg);
    }
    
    async function start() {
      try {
        // Check library loaded
        if (typeof LiveKitClient === 'undefined') {
          throw new Error('LiveKit library not loaded - check livekit-client.min.js exists');
        }
        
        log('âœ“ LiveKit library loaded!', 'success');
        
        log('ðŸ“¹ Step 1: Requesting camera...', 'pending');
        
        const localStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 }
          },
          audio: false
        });
        
        localVideo.srcObject = localStream;
        log('âœ“ Camera captured successfully', 'success');
        log(`  Stream ID: ${localStream.id.substring(0, 20)}...`, '');
        
        log('ðŸ”Œ Step 2: Fetching LiveKit token...', 'pending');
        
        const tokenResponse = await fetch(`http://localhost:3001/token?identity=browser-camera&roomName=${ROOM_NAME}`);
        if (!tokenResponse.ok) {
          throw new Error(`Token fetch failed: ${tokenResponse.status}`);
        }
        
        const tokenData = await tokenResponse.json();
        
        if (!tokenData.token || tokenData.token === 'DEV-PLACEHOLDER-TOKEN') {
          throw new Error('Need real LiveKit token. Start token endpoint with env vars.');
        }
        
        log('âœ“ Token received', 'success');
        
        log('ðŸŒ Step 3: Connecting to LiveKit Cloud...', 'pending');
        log(`  URL: ${LIVEKIT_URL}`, '');
        log(`  Room: ${ROOM_NAME}`, '');
        
        const room = new LiveKitClient.Room({
          adaptiveStream: true,
          dynacast: true,
          videoCaptureDefaults: {
            resolution: LiveKitClient.VideoPresets.h720.resolution,
          }
        });
        
        room.on('connected', () => {
          log('âœ“ Room connected!', 'success');
        });
        
        room.on('disconnected', () => {
          log('âš  Disconnected from room', 'error');
        });
        
        await room.connect(LIVEKIT_URL, tokenData.token);
        log('âœ“ Connected to LiveKit Cloud', 'success');
        
        log('ðŸ“¤ Step 4: Publishing camera track...', 'pending');
        
        const videoTrack = localStream.getVideoTracks()[0];
        const publication = await room.localParticipant.publishTrack(videoTrack, {
          name: 'camera',
          simulcast: false,
          videoCodec: 'vp8'
        });
        
        log('âœ“ Camera published to LiveKit!', 'success');
        log(`  Track SID: ${publication.trackSid}`, '');
        log('', '');
        log('ðŸŽ‰ SUCCESS! Camera streaming to LiveKit Cloud', 'success');
        log('âœ“ TouchDesigner can now subscribe to:', '');
        log(`  Room: ${ROOM_NAME}`, '');
        log(`  Participant: browser-camera`, '');
        log(`  Track: camera`, '');
        
      } catch (err) {
        log(`âœ— ERROR: ${err.message}`, 'error');
        console.error('Full error:', err);
        
        if (err.message.includes('token')) {
          log('', '');
          log('Need to start LiveKit token endpoint:', 'error');
          log('In PowerShell: cd to project directory and run:', '');
          log('node livekit_token_endpoint.js', '');
        }
      }
    }
    
    // Auto-start
    start();
  </script>
</body>
</html>
