<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TD Input Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
        }
        
        #videoContainer {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(0, 255, 0, 0.2);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            z-index: 100;
        }
        
        #status.error {
            background: rgba(255, 0, 0, 0.2);
            color: #f00;
            border-color: #f00;
        }
        
        #status.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="videoContainer">
        <video id="remoteVideo" autoplay playsinline muted></video>
    </div>
    <div id="status">Connecting to LiveKit...</div>
    
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
    <script>
        // AUTO-CONNECTING LIVEKIT VIEWER FOR TOUCHDESIGNER
        // Subscribes to the INPUT room (claymation-live) to receive remote camera feeds
        
        let room = null;
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');
        
        // Auto-connect on page load
        window.addEventListener('DOMContentLoaded', autoConnect);
        
        async function autoConnect() {
            try {
                updateStatus('Fetching LiveKit token...');
                
                // Get token for the INPUT viewer (claymation-live room)
                const response = await fetch('/api/viewer-token');
                if (!response.ok) {
                    throw new Error(`Token request failed: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Token received for room:', data.room);
                
                updateStatus('Connecting to LiveKit room...');
                
                // Create LiveKit room
                room = new LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true,
                    videoCaptureDefaults: {
                        resolution: LivekitClient.VideoPresets.h720.resolution,
                    }
                });
                
                // Handle incoming video tracks
                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    console.log('üìπ Track subscribed:', track.kind, 'from', participant.identity);
                    
                    if (track.kind === LivekitClient.Track.Kind.Video) {
                        // Attach video track to video element
                        track.attach(remoteVideo);
                        updateStatus(`‚úÖ Receiving video from ${participant.identity}`);
                        
                        // Hide status after 3 seconds
                        setTimeout(() => {
                            statusDiv.classList.add('hidden');
                        }, 3000);
                    }
                });
                
                // Handle track unsubscribed
                room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
                    console.log('üìπ Track unsubscribed from', participant.identity);
                    track.detach(remoteVideo);
                    updateStatus('Waiting for video...', false);
                    statusDiv.classList.remove('hidden');
                });
                
                // Handle participant connected
                room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
                    console.log('üë§ Participant connected:', participant.identity);
                    updateStatus(`Participant joined: ${participant.identity}`);
                });
                
                // Handle participant disconnected
                room.on(LivekitClient.RoomEvent.ParticipantDisconnected, (participant) => {
                    console.log('üë§ Participant disconnected:', participant.identity);
                    updateStatus('Publisher disconnected', false);
                    statusDiv.classList.remove('hidden');
                });
                
                // Handle room disconnected
                room.on(LivekitClient.RoomEvent.Disconnected, (reason) => {
                    console.log('‚ùå Disconnected from room:', reason);
                    updateStatus('Disconnected - Reconnecting...', true);
                    
                    // Auto-reconnect after 3 seconds
                    setTimeout(autoConnect, 3000);
                });
                
                // Handle connection state changes
                room.on(LivekitClient.RoomEvent.ConnectionStateChanged, (state) => {
                    console.log('üîå Connection state:', state);
                    
                    if (state === LivekitClient.ConnectionState.Connected) {
                        updateStatus('‚úÖ Connected to LiveKit room');
                    } else if (state === LivekitClient.ConnectionState.Reconnecting) {
                        updateStatus('Reconnecting...', false);
                        statusDiv.classList.remove('hidden');
                    }
                });
                
                // Connect to room
                await room.connect(data.url, data.token);
                console.log('‚úÖ Connected to LiveKit room:', data.room);
                
                updateStatus('‚úÖ Connected - Waiting for publisher...');
                
                // Check if there are already participants publishing
                const participants = Array.from(room.remoteParticipants.values());
                if (participants.length > 0) {
                    console.log('üë• Found', participants.length, 'existing participants');
                }
                
            } catch (error) {
                console.error('‚ùå Connection error:', error);
                updateStatus(`Error: ${error.message}`, true);
                
                // Try to reconnect after 5 seconds on error
                setTimeout(autoConnect, 5000);
            }
        }
        
        function updateStatus(message, isError = false) {
            console.log('üìä', message);
            statusDiv.textContent = message;
            
            if (isError) {
                statusDiv.classList.add('error');
            } else {
                statusDiv.classList.remove('error');
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (room) {
                room.disconnect();
            }
        });
        
        // Log all video elements for debugging
        remoteVideo.addEventListener('loadedmetadata', () => {
            console.log('üì∫ Video metadata loaded');
            console.log('   Width:', remoteVideo.videoWidth);
            console.log('   Height:', remoteVideo.videoHeight);
        });
        
        remoteVideo.addEventListener('playing', () => {
            console.log('‚ñ∂Ô∏è Video playing');
        });
    </script>
</body>
</html>
