<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TD Input Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; }
        #videoContainer { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        #status { position: absolute; top: 20px; left: 20px; padding: 10px 20px; background: rgba(0,255,0,0.2); color: #0f0; border: 1px solid #0f0; border-radius: 4px; font-family: monospace; font-size: 14px; z-index: 100; }
        #status.error { background: rgba(255,0,0,0.2); color: #f00; border-color: #f00; }
        #status.hidden { display: none; }
    </style>
</head>
<body>
    <div id="videoContainer">
        <video id="remoteVideo" autoplay playsinline muted></video>
    </div>
    <div id="status">Connecting to LiveKit...</div>
    
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
    <script>
        let room = null;
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');
        
        window.addEventListener('DOMContentLoaded', autoConnect);
        
        async function autoConnect() {
            try {
                updateStatus('Fetching LiveKit token...');
                const response = await fetch('/api/viewer-token');
                if (!response.ok) throw new Error(`Token request failed: ${response.status}`);
                const data = await response.json();
                
                updateStatus('Connecting to LiveKit room...');
                room = new LivekitClient.Room({ adaptiveStream: true, dynacast: true });
                
                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    if (track.kind === LivekitClient.Track.Kind.Video) {
                        track.attach(remoteVideo);
                        updateStatus(`Receiving video from ${participant.identity}`);
                        setTimeout(() => statusDiv.classList.add('hidden'), 3000);
                    }
                });
                
                room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
                    track.detach(remoteVideo);
                    updateStatus('Waiting for video...');
                    statusDiv.classList.remove('hidden');
                });
                
                room.on(LivekitClient.RoomEvent.Disconnected, () => {
                    updateStatus('Disconnected - Reconnecting...', true);
                    setTimeout(autoConnect, 3000);
                });
                
                await room.connect(data.url, data.token);
                updateStatus('Connected - Waiting for publisher...');
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, true);
                setTimeout(autoConnect, 5000);
            }
        }
        
        function updateStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.classList.toggle('error', isError);
        }
        
        window.addEventListener('beforeunload', () => { if (room) room.disconnect(); });
    </script>
</body>
</html>
