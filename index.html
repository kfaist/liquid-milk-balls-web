<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Mirror's Echo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --hue: 280; --comp: 100; }
        body { font-family: system-ui, sans-serif; background: #000; color: #fff; }
        
        body.view-mode { overflow: hidden; }
        body.view-mode .main-ui { display: none; }
        body.view-mode .fs-view { display: block; }
        .fs-view { display: none; position: fixed; inset: 0; background: #000; }
        .fs-view video { width: 100%; height: 100%; object-fit: cover; }
        .fs-exit { position: fixed; top: 8px; right: 8px; z-index: 10001; padding: 6px 12px; background: rgba(0,0,0,0.7); border: 1px solid #666; color: #fff; cursor: pointer; font-size: 11px; opacity: 0.6; }
        .fs-exit:hover { opacity: 1; }
        
        .main-ui { max-width: 1100px; margin: 0 auto; padding: 2rem; }
        h1 { text-align: center; font-size: 1.3rem; font-weight: 300; letter-spacing: 0.15em; margin-bottom: 0.5rem; }
        .intro { text-align: center; margin-bottom: 1.5rem; }
        .intro p { font-size: 0.8rem; opacity: 0.7; line-height: 1.6; max-width: 700px; margin: 0 auto 0.75rem; }
        .contacts { font-size: 0.75rem; opacity: 0.7; }
        .contacts a { color: #fff; text-decoration: none; border-bottom: 1px solid rgba(255,255,255,0.3); }
        .contacts a:hover { border-color: #fff; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem; }
        .box { position: relative; }
        .label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.5; margin-bottom: 0.4rem; }
        .vid-wrap { position: relative; aspect-ratio: 16/9; background: #111; border: 1px solid #333; }
        .vid-wrap video { width: 100%; height: 100%; object-fit: cover; }
        .pop-btn { position: absolute; top: 6px; right: 6px; padding: 4px 8px; font-size: 10px; background: rgba(0,0,0,0.8); border: 1px solid #555; color: #aaa; cursor: pointer; z-index: 10; opacity: 0.7; }
        .pop-btn:hover { opacity: 1; border-color: #fff; color: #fff; }
        .pop-btn:disabled { display: none; }
        
        .btns { display: flex; gap: 0.5rem; margin-top: 0.75rem; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 500; background: #111; border: 2px solid #fff; color: #fff; cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; }
        .btn:hover { background: #fff; color: #000; }
        .btn:disabled { opacity: 0.25; cursor: not-allowed; border-color: #555; }
        .btn.on { background: #0a0; border-color: #0a0; color: #fff; }
        select.btn { padding: 0.4rem; font-size: 0.7rem; max-width: 160px; }
        
        /* Color Palette */
        .palette-section { background: #0a0a0a; border: 1px solid #222; padding: 1rem; margin-bottom: 1.5rem; }
        .palette-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.5; margin-bottom: 0.75rem; }
        .palette { display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .palette-btn { aspect-ratio: 1; border: 2px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; transition: all 0.2s; opacity: 0.6; min-height: 40px; }
        .palette-btn:hover { opacity: 0.85; transform: scale(1.05); border-color: rgba(255,255,255,0.5); }
        .palette-btn.active { opacity: 1; border-color: #fff; box-shadow: 0 0 12px currentColor; }
        
        .color-slider { display: flex; align-items: center; gap: 1rem; }
        .color-slider label { font-size: 0.65rem; text-transform: uppercase; opacity: 0.5; }
        .color-slider input { flex: 1; }
        .color-slider span { font-size: 0.8rem; color: hsl(var(--hue), 85%, 65%); min-width: 45px; text-align: right; }
        
        /* Rainbow gradient for color slider */
        #colorSlider, #hue {
            background: linear-gradient(to right, 
                hsl(0, 85%, 55%), 
                hsl(60, 85%, 55%), 
                hsl(120, 85%, 55%), 
                hsl(180, 85%, 55%), 
                hsl(240, 85%, 55%), 
                hsl(300, 85%, 55%), 
                hsl(360, 85%, 55%)) !important;
            height: 6px !important;
        }
        
        .controls { background: #111; border: 1px solid #333; padding: 1rem; margin-bottom: 1.5rem; display: flex; gap: 1.5rem; justify-content: center; align-items: center; flex-wrap: wrap; }
        .controls label { font-size: 0.75rem; opacity: 0.7; margin-right: 0.3rem; }
        .controls input[type="range"] { width: 100px; vertical-align: middle; }
        /* Value numbers = complementary color, except color slider = selected hue */
        .controls span, .sl span { font-size: 0.8rem; color: hsl(var(--comp), 85%, 65%); min-width: 40px; display: inline-block; }
        .color-slider span { color: hsl(var(--hue), 85%, 65%) !important; }
        
        .sliders { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; background: #0a0a0a; border: 1px solid #222; padding: 1rem; margin-bottom: 2rem; }
        .sl label { display: block; font-size: 0.65rem; opacity: 0.6; margin-bottom: 0.25rem; }
        .sl input { width: 100%; }
        
        /* Slider thumb styles */
        input[type="range"] { -webkit-appearance: none; background: rgba(255,255,255,0.15); height: 4px; border-radius: 2px; }
        
        /* Hue/Color slider thumb = selected hue */
        #hue::-webkit-slider-thumb, #colorSlider::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; 
            background: hsl(var(--hue), 85%, 55%); 
            border: 3px solid #fff; cursor: pointer; 
            box-shadow: 0 0 8px hsl(var(--hue), 85%, 55%);
        }
        #hue::-moz-range-thumb, #colorSlider::-moz-range-thumb { 
            width: 20px; height: 20px; border-radius: 50%; 
            background: hsl(var(--hue), 85%, 55%); 
            border: 3px solid #fff; cursor: pointer; 
        }
        
        /* All OTHER slider thumbs = complementary color */
        input[type="range"]:not(#hue):not(#colorSlider)::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; 
            background: hsl(var(--comp), 85%, 55%); 
            border: 2px solid rgba(255,255,255,0.7); cursor: pointer; 
            box-shadow: 0 0 6px hsl(var(--comp), 85%, 55%);
        }
        input[type="range"]:not(#hue):not(#colorSlider)::-moz-range-thumb { 
            width: 16px; height: 16px; border-radius: 50%; 
            background: hsl(var(--comp), 85%, 55%); 
            border: 2px solid rgba(255,255,255,0.7); cursor: pointer; 
        }
        
        /* Licensing Section */
        .licensing { margin: 3rem 0; }
        .licensing h2 { text-align: center; font-size: 1.1rem; font-weight: 300; letter-spacing: 0.15em; font-style: italic; margin-bottom: 0.5rem; padding-bottom: 1rem; border-bottom: 1px solid #333; }
        .licensing h3 { font-size: 0.9rem; font-weight: 400; margin: 1.5rem 0 0.75rem; opacity: 0.9; }
        .about-content { max-width: 800px; margin: 0 auto; padding: 1.5rem 0; }
        .about-content p { font-size: 0.8rem; line-height: 1.7; opacity: 0.8; margin-bottom: 1rem; }
        .pipeline { font-family: monospace; font-size: 0.75rem; background: #111; border: 1px solid #333; padding: 1rem; overflow-x: auto; line-height: 1.5; opacity: 0.8; }
        .tech-list { list-style: none; font-size: 0.8rem; opacity: 0.8; margin: 0.75rem 0; }
        .tech-list li { padding: 0.4rem 0 0.4rem 1rem; position: relative; }
        .tech-list li::before { content: "•"; position: absolute; left: 0; opacity: 0.5; }
        .signal-path { font-family: monospace; font-size: 0.75rem; background: #0a0a0a; border: 1px solid #222; padding: 0.75rem; margin-top: 1rem; }
        .license-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-top: 1.5rem; }
        .license-box { border: 1px solid #333; padding: 1.5rem; }
        .license-type { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.5; margin-bottom: 0.75rem; }
        .license-title { font-size: 1rem; font-weight: 400; margin-bottom: 1rem; }
        .license-desc { font-size: 0.75rem; opacity: 0.7; line-height: 1.6; margin-bottom: 1rem; }
        .license-features { list-style: none; font-size: 0.75rem; opacity: 0.8; margin: 0.75rem 0; padding-left: 1.25rem; }
        .license-features li { margin-bottom: 0.4rem; padding-bottom: 0; line-height: 1.4; padding-left: 1rem; position: relative; }
        .license-features li::before { content: "—"; position: absolute; left: 0; opacity: 0.5; }
        .license-btn { display: block; width: 100%; padding: 0.75rem; text-align: center; border: 1px solid #fff; background: transparent; color: #fff; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; text-decoration: none; }
        .license-btn:hover { background: #fff; color: #000; }
        
        .raindrop { position: fixed; border-radius: 50%; pointer-events: none; }
        @keyframes drop { 0%{opacity:0;transform:scale(0.5)} 15%{opacity:1;transform:scale(1)} 85%{opacity:1} 100%{opacity:0;transform:scale(1.1)} }
        
        @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } .sliders { grid-template-columns: 1fr 1fr; } .palette { grid-template-columns: repeat(4, 1fr); } .license-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="fs-view" id="fsLocal"><video id="fsLocalV" autoplay muted playsinline></video></div>
    <div class="fs-view" id="fsRemote"><video id="fsRemoteV" autoplay playsinline></video></div>
    <button class="fs-exit" id="fsExit" style="display:none">✕ EXIT</button>

    <div class="main-ui">
        <h1>THE MIRROR'S ECHO</h1>
        <div class="intro">
            <p>The Mirror's Echo operates as an unlimited edition under open-source principles (AGPL-3.0), ensuring accessibility while sustaining ongoing development. Exhibition licenses and institutional partnerships support the continued evolution of networked digital art practices.</p>
            <div class="contacts">
                Artist/Technical: <a href="mailto:kristabluedoor@gmail.com">kristabluedoor@gmail.com</a> · 
                Curatorial/Institutional: <a href="mailto:chaoscontemporarycraft@gmail.com">chaoscontemporarycraft@gmail.com</a>
            </div>
        </div>

        <div class="grid">
            <div class="box">
                <div class="label">Local Camera</div>
                <div class="vid-wrap">
                    <video id="localV" autoplay muted playsinline></video>
                    <button class="pop-btn" id="popL" disabled>↗</button>
                </div>
                <div class="btns">
                    <button class="btn" id="camBtn">START MY WEBCAM</button>
                    <button class="btn" id="micBtn" disabled>MIC OFF</button>
                    <button class="btn" id="discBtn" disabled>DISCONNECT</button>
                    <button class="btn" id="fullLocalBtn" disabled>FULLSCREEN</button>
                </div>
            </div>
            <div class="box">
                <div class="label">Remote Stream (OBS/NDI/Camera)</div>
                <div class="vid-wrap">
                    <video id="remoteV" autoplay playsinline></video>
                    <button class="pop-btn" id="popR" disabled>↗</button>
                </div>
                <div class="btns">
                    <select class="btn" id="remoteCam"><option value="">Select source...</option></select>
                    <button class="btn" id="refreshCam">⟳ REFRESH</button>
                    <button class="btn" id="remoteBtn">START</button>
                    <button class="btn" id="webrtcBtn" disabled>CONNECT TO WEBRTC</button>
                    <button class="btn" id="fullBtn" disabled>FULLSCREEN</button>
                </div>
            </div>
        </div>

        <!-- Color Palette -->
        <div class="palette-section">
            <div class="palette-label">Color Palette</div>
            <div class="palette">
                <button class="palette-btn active" data-hue="280" style="background: hsl(280, 85%, 55%);" title="Purple"></button>
                <button class="palette-btn" data-hue="320" style="background: hsl(320, 90%, 55%);" title="Pink"></button>
                <button class="palette-btn" data-hue="15" style="background: hsl(15, 90%, 55%);" title="Coral"></button>
                <button class="palette-btn" data-hue="45" style="background: hsl(45, 90%, 55%);" title="Gold"></button>
                <button class="palette-btn" data-hue="120" style="background: hsl(120, 85%, 45%);" title="Green"></button>
                <button class="palette-btn" data-hue="180" style="background: hsl(180, 85%, 45%);" title="Cyan"></button>
                <button class="palette-btn" data-hue="220" style="background: hsl(220, 85%, 55%);" title="Blue"></button>
                <button class="palette-btn" data-hue="0" style="background: hsl(0, 85%, 55%);" title="Red"></button>
            </div>
            <div class="color-slider">
                <label>Color</label>
                <input type="range" id="colorSlider" min="0" max="360" value="280">
                <span id="colorVal">280°</span>
            </div>
        </div>

        <div class="controls">
            <div><label>Temporal Intensity</label><input type="range" id="temp" min="0" max="100" value="1"><span id="tempV">1%</span></div>
            <div><label>Intensity</label><input type="range" id="int" min="0" max="100" value="0"><span id="intV">0%</span></div>
            <div><label>Speed</label><input type="range" id="spd" min="5" max="30" value="10"><span id="spdV">1.0x</span></div>
        </div>

        <div class="sliders">
            <div class="sl"><label>Hue <span id="hueV">280°</span></label><input type="range" id="hue" min="0" max="360" value="280"></div>
            <div class="sl"><label>Saturation <span id="satV">85%</span></label><input type="range" id="sat" min="0" max="100" value="85"></div>
            <div class="sl"><label>Size <span id="szV">50</span></label><input type="range" id="sz" min="10" max="120" value="50"></div>
            <div class="sl"><label>Glow <span id="glwV">60</span></label><input type="range" id="glw" min="0" max="100" value="60"></div>
        </div>

        <!-- Licensing Section -->
        <div class="licensing">
            <h2>About</h2>
            <div class="about-content">
                <p>The Mirror's Echo is a networked interactive work exploring presence, temporality, and reciprocity through real-time video transmission. The piece positions participants as both observers and subjects, creating a feedback loop where actions generate visual echoes that accumulate and transform over time.</p>
                <p>Built on open protocols (WebRTC, LiveKit, NDI), the work operates as distributed infrastructure - each interaction exists simultaneously across multiple nodes: browser, server, and optional processing environments. This architecture enables the piece to function as both a self-contained web experience and as material for live visual manipulation through tools like TouchDesigner.</p>
                <p>The work implements a temporal access model: seven minutes of unmediated experience, followed by progressive visual markers that reveal the piece's constructed nature. This durational framework questions assumptions about digital permanence and the economics of networked art.</p>
                <p>Technical implementation merges web-native technologies with broadcast/VJ workflows, positioning the work within lineages of video feedback art (Steina & Woody Vasulka), telepresence projects (Kit Galloway & Sherrie Rabinowitz's Satellite Arts), and contemporary networked performance practices.</p>
                
                <h3>Processing Pipeline</h3>
                <pre class="pipeline">Camera Input → WebRTC/LiveKit → NVIDIA GPU Processing
       ↓
Audio Stream → Whisper (Speech-to-Text)
       ↓
Text → spaCy NLP (Entity Recognition, Semantic Analysis)
       ↓
Video → TouchDesigner (Visual Processing, Effects, Generative Response)
       ↓
Composite Output → NDI → OBS → WebRTC Return Path
       ↓
Remote Viewer (Browser/Display)</pre>

                <h3>Technical Infrastructure</h3>
                <p>For production-quality streaming with OBS, NDI, and TouchDesigner integration:</p>
                <p><strong>Complete Bidirectional Workflow:</strong></p>
                <ul class="tech-list">
                    <li><strong>Publisher Page:</strong> Remote user captures webcam and publishes to LiveKit</li>
                    <li><strong>NDI Viewer Page:</strong> View the LiveKit stream (capture this in OBS Browser Source)</li>
                    <li><strong>OBS:</strong> Capture NDI viewer page and enable NDI output (Tools → NDI Output Settings)</li>
                    <li><strong>TouchDesigner:</strong> Use NDI In TOP to receive stream from OBS, process & stylize</li>
                    <li><strong>TD Output:</strong> Use NDI Out TOP to send processed video back to OBS</li>
                    <li><strong>OBS Capture:</strong> Add NDI Source in OBS to receive processed video from TD</li>
                    <li><strong>Return Viewer Page:</strong> Remote user views processed video with fullscreen option</li>
                </ul>
                <p class="signal-path">Signal Path: Remote Camera → LiveKit → OBS → NDI → TouchDesigner (process) → NDI → Back to Remote Viewer in Real-Time</p>

                <h3>Interaction</h3>
                <p>The work responds to presence through multiple modes of engagement. Each interaction generates visual echoes that accumulate temporally within the system.</p>
                <p><strong>Mirror Interface:</strong> Direct interaction with the circular interface generates ripple formations. Accumulated interactions trigger chromatic shifts every five engagements. The Clear function returns the system to its initial state.</p>
                <p><strong>Video Transmission:</strong> WebRTC protocols enable peer-to-peer video transmission. Local and remote streams establish reciprocal viewing positions. The work's temporal markers emerge after seven minutes of sustained connection, revealing the constructed nature of the experience.</p>
            </div>
        </div>

        <!-- Licensing Section -->
        <div class="licensing">
            <h2>Licensing & Access</h2>
            <div class="license-grid">
                <div class="license-box">
                    <div class="license-type">Open Access</div>
                    <div class="license-title">Unlimited Edition</div>
                    <div class="license-desc">An unlimited edition available under open-source principles. Experience the work freely for educational, research, and non-commercial contexts. The piece presents itself fully for seven minutes before revealing its temporal nature through progressive visual markers.</div>
                    <ul class="license-features">
                        <li>Full source code access (AGPL-3.0)</li>
                        <li>Unlimited non-commercial use</li>
                        <li>Seven-minute sustained experience without watermarking</li>
                        <li>Community & documentation support</li>
                    </ul>
                    <a href="https://github.com/kfaist/liquid-milk-balls-web" class="license-btn" target="_blank">Access Source Code</a>
                    <!-- Sustain the Practice PayPal Button -->
                    <a href="https://www.paypal.com/donate/?business=5Z98T6764VA96&no_recurring=0&item_name=Support+ongoing+development+of+The+Mirror%27s+Echo&currency_code=USD"
                       class="license-btn"
                       target="_blank"
                       style="margin-top: 0.75rem; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        Sustain the Practice
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;opacity:0.85;">
                            <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944 3.72a.77.77 0 0 1 .757-.629h6.724c2.231 0 3.933.605 5.059 1.799.964 1.023 1.428 2.467 1.381 4.291-.012.467-.065.934-.157 1.395a7.3 7.3 0 0 1-.675 1.957 5.87 5.87 0 0 1-1.179 1.555c-.487.465-1.065.832-1.718 1.091-.623.247-1.347.396-2.151.446-.303.019-.615.028-.928.028H9.57a.77.77 0 0 0-.757.629l-.88 5.606a.641.641 0 0 1-.633.54h-.001l-.223-.001zM19.165 8.564c-.014.092-.03.186-.048.281-.597 3.045-2.633 4.049-5.235 4.049h-1.323a.641.641 0 0 0-.633.54l-.863 5.497-.244 1.557a.337.337 0 0 0 .333.39h2.34a.539.539 0 0 0 .531-.44l.022-.11.418-2.665.027-.144a.539.539 0 0 1 .531-.44h.336c2.165 0 3.86-.879 4.356-3.423.207-.106.381-2.272.155-3.092z"/>
                        </svg>
                    </a>
                </div>
                <div class="license-box">
                    <div class="license-type">Starting at $400</div>
                    <div class="license-title">Exhibition License & Technical Residency</div>
                    <div class="license-desc">For professional contexts, commercial applications, and exhibition settings. Includes unrestricted access to the work without temporal markers, plus optional technical residency support for complex integrations.</div>
                    <ul class="license-features">
                        <li>Commercial exhibition rights</li>
                        <li>Professional use licensing</li>
                        <li>Optional: Technical residency support ($150/hour)</li>
                        <li>TouchDesigner/LiveKit integration consultation</li>
                        <li>Custom configuration assistance</li>
                    </ul>
                    <a href="mailto:kristabluedoor@gmail.com?subject=Exhibition License Inquiry" class="license-btn">Purchase Exhibition License - $400</a>
                    <a href="mailto:kristabluedoor@gmail.com?subject=Technical Residency Inquiry" class="license-btn" style="margin-top: 0.5rem;">Book Technical Residency - $150/hour</a>
                </div>
                <div class="license-box">
                    <div class="license-type">Contact</div>
                    <div class="license-title">Curatorial & Institutional Partnership</div>
                    <div class="license-desc">For galleries, museums, and biennials. Comprehensive partnership with curatorial consultation and on-site residency throughout the exhibition period.</div>
                    <ul class="license-features">
                        <li>Complete licensing</li>
                        <li>Curatorial consultation</li>
                        <li>On-site residency</li>
                    </ul>
                    <a href="mailto:chaoscontemporarycraft@gmail.com?subject=Institutional Partnership Inquiry" class="license-btn">Initiate Partnership</a>
                </div>
            </div>
        </div>
    </div>

<script>
const S = {hue:280, sat:85, int:0, sz:50, spd:10, glw:60, temp:1};
let stream = null;
let remoteStream = null;
let micOn = false;
const startTime = Date.now();
const rainStartTime = 480000; // 8 minutes

function updateColors() {
    document.documentElement.style.setProperty('--hue', S.hue);
    document.documentElement.style.setProperty('--comp', (S.hue + 180) % 360);
}
updateColors();

// URL view mode
const view = new URLSearchParams(location.search).get('view');
if (view === 'local' || view === 'remote') {
    document.body.classList.add('view-mode');
    document.getElementById(view === 'local' ? 'fsLocal' : 'fsRemote').style.display = 'block';
    document.getElementById('fsExit').style.display = 'block';
    if (view === 'local') {
        navigator.mediaDevices.getUserMedia({video:{width:1920,height:1080},audio:false})
            .then(s => { document.getElementById('fsLocalV').srcObject = s; })
            .catch(console.error);
    }
}
document.getElementById('fsExit').onclick = () => { location.href = location.pathname; };

// Populate camera dropdown
async function populateCameras() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const select = document.getElementById('remoteCam');
        while (select.options.length > 1) select.remove(1);
        devices.filter(d => d.kind === 'videoinput').forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.textContent = d.label || 'Camera ' + select.options.length;
            select.appendChild(opt);
        });
    } catch(e) { console.error(e); }
}

// Request camera permission on dropdown click to get device labels
document.getElementById('remoteCam').onclick = async function() {
    if (this.options.length <= 1) {
        try {
            const tempStream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
            tempStream.getTracks().forEach(t => t.stop());
            populateCameras();
        } catch(e) { console.error(e); }
    }
};

// Also try on page load
populateCameras();

// Refresh cameras button
document.getElementById('refreshCam').onclick = async function() {
    this.textContent = '...';
    try {
        const tempStream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
        tempStream.getTracks().forEach(t => t.stop());
        await populateCameras();
        this.textContent = '⟳ REFRESH';
    } catch(e) {
        console.error(e);
        this.textContent = '⟳ REFRESH';
    }
};

// START WEBCAM
document.getElementById('camBtn').onclick = async function() {
    this.textContent = 'STARTING...';
    try {
        stream = await navigator.mediaDevices.getUserMedia({video: {width: 1280, height: 720}, audio: true});
        document.getElementById('localV').srcObject = stream;
        stream.getAudioTracks().forEach(t => { t.enabled = false; });
        this.textContent = 'WEBCAM ON';
        this.classList.add('on');
        document.getElementById('popL').disabled = false;
        document.getElementById('micBtn').disabled = false;
        document.getElementById('discBtn').disabled = false;
        document.getElementById('fullLocalBtn').disabled = false;
        setTimeout(populateCameras, 500);
    } catch(e) {
        console.error(e);
        this.textContent = 'RETRY';
    }
};

// MIC TOGGLE
document.getElementById('micBtn').onclick = function() {
    if (!stream) return;
    micOn = !micOn;
    stream.getAudioTracks().forEach(t => { t.enabled = micOn; });
    this.textContent = micOn ? 'MIC ON' : 'MIC OFF';
    this.classList.toggle('on', micOn);
};

// DISCONNECT LOCAL
document.getElementById('discBtn').onclick = function() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        document.getElementById('localV').srcObject = null;
        document.getElementById('camBtn').textContent = 'START MY WEBCAM';
        document.getElementById('camBtn').classList.remove('on');
        document.getElementById('micBtn').disabled = true;
        document.getElementById('discBtn').disabled = true;
        document.getElementById('fullLocalBtn').disabled = true;
        document.getElementById('popL').disabled = true;
    }
};

// FULLSCREEN LOCAL
document.getElementById('fullLocalBtn').onclick = function() {
    const vid = document.getElementById('localV');
    if (vid.requestFullscreen) vid.requestFullscreen();
};

// REMOTE STREAM START
document.getElementById('remoteBtn').onclick = async function() {
    const deviceId = document.getElementById('remoteCam').value;
    this.textContent = 'STARTING...';
    try {
        const constraints = deviceId 
            ? { video: { deviceId: { exact: deviceId }, width: 1280, height: 720 }, audio: false }
            : { video: { width: 1280, height: 720 }, audio: false };
        remoteStream = await navigator.mediaDevices.getUserMedia(constraints);
        document.getElementById('remoteV').srcObject = remoteStream;
        document.getElementById('fsRemoteV').srcObject = remoteStream;
        this.textContent = 'ON';
        this.classList.add('on');
        document.getElementById('popR').disabled = false;
        document.getElementById('fullBtn').disabled = false;
        document.getElementById('webrtcBtn').disabled = false;
        populateCameras();
    } catch(e) {
        console.error(e);
        this.textContent = 'RETRY';
    }
};

// WEBRTC CONNECT (placeholder)
document.getElementById('webrtcBtn').onclick = function() {
    this.textContent = 'CONNECTED';
    this.classList.add('on');
};

// FULLSCREEN REMOTE
document.getElementById('fullBtn').onclick = function() {
    const vid = document.getElementById('remoteV');
    if (vid.requestFullscreen) vid.requestFullscreen();
};

// POP OUT BUTTONS
document.getElementById('popL').onclick = () => {
    window.open(location.pathname + '?view=local', '_blank', 'width=1280,height=720');
};
document.getElementById('popR').onclick = () => {
    window.open(location.pathname + '?view=remote', '_blank', 'width=1280,height=720');
};

// COLOR PALETTE
document.querySelectorAll('.palette-btn').forEach(btn => {
    btn.onclick = function() {
        const hue = +this.dataset.hue;
        S.hue = hue;
        document.getElementById('hue').value = hue;
        document.getElementById('hueV').textContent = hue + '°';
        document.getElementById('colorSlider').value = hue;
        document.getElementById('colorVal').textContent = hue + '°';
        document.querySelectorAll('.palette-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        updateColors();
    };
});

// COLOR SLIDER
document.getElementById('colorSlider').oninput = function() {
    S.hue = +this.value;
    document.getElementById('hue').value = S.hue;
    document.getElementById('hueV').textContent = S.hue + '°';
    document.getElementById('colorVal').textContent = S.hue + '°';
    document.querySelectorAll('.palette-btn').forEach(b => b.classList.remove('active'));
    updateColors();
};

// TEMPORAL INTENSITY, INTENSITY & SPEED
document.getElementById('temp').oninput = function() {
    S.temp = +this.value;
    document.getElementById('tempV').textContent = S.temp + '%';
};
document.getElementById('int').oninput = function() {
    S.int = +this.value;
    document.getElementById('intV').textContent = S.int + '%';
};
document.getElementById('spd').oninput = function() {
    S.spd = +this.value;
    document.getElementById('spdV').textContent = (S.spd / 10).toFixed(1) + 'x';
};

// SLIDERS
document.getElementById('hue').oninput = function() {
    S.hue = +this.value;
    document.getElementById('hueV').textContent = S.hue + '°';
    document.getElementById('colorSlider').value = S.hue;
    document.getElementById('colorVal').textContent = S.hue + '°';
    document.querySelectorAll('.palette-btn').forEach(b => b.classList.remove('active'));
    updateColors();
};
document.getElementById('sat').oninput = function() {
    S.sat = +this.value;
    document.getElementById('satV').textContent = S.sat + '%';
};
document.getElementById('sz').oninput = function() {
    S.sz = +this.value;
    document.getElementById('szV').textContent = S.sz;
};
document.getElementById('glw').oninput = function() {
    S.glw = +this.value;
    document.getElementById('glwV').textContent = S.glw;
};

// RAINDROP SPAWNING
function spawnDrop() {
    const d = document.createElement('div');
    d.className = 'raindrop';
    const useHue = Math.random() < 0.30;
    const h = useHue ? S.hue + (Math.random() * 50 - 25) : Math.random() * 360;
    const size = S.sz * (0.5 + Math.random());
    const opacity = 0.4 + (S.int / 100) * 0.5;
    const glow = S.glw * 0.8;
    const duration = 4 / (S.spd / 10);
    d.style.cssText = `left:${Math.random()*100}vw;top:${Math.random()*100}vh;width:${size}px;height:${size}px;background:radial-gradient(circle at 30% 30%,hsla(${h},${S.sat}%,75%,${opacity+0.2}),hsla(${h},${S.sat}%,55%,${opacity}),transparent);box-shadow:0 0 ${glow}px hsl(${h},${S.sat}%,60%);animation:drop ${duration}s ease-out forwards;z-index:${1000+Math.floor(Math.random()*500)};`;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), duration * 1000);
}

// ANIMATION LOOP
function loop() {
    const elapsed = Date.now() - startTime;
    // Manual intensity drops
    if (S.int > 0) {
        const chance = S.int / 500;
        if (Math.random() < chance) spawnDrop();
    }
    // Temporal intensity drops (after 8 min, scaled by temp slider)
    if (elapsed >= rainStartTime && S.temp > 0) {
        const progress = Math.min((elapsed - rainStartTime) / 120000, 1);
        const autoChance = (0.02 + progress * 0.15) * (S.temp / 100);
        if (Math.random() < autoChance) spawnDrop();
    }
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
