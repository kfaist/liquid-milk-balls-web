<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Mirror's Echo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --hue: 280; --comp: 100; }
        body { font-family: system-ui, sans-serif; background: #000; color: #fff; }
        
        body.view-mode { overflow: hidden; }
        body.view-mode .main-ui { display: none; }
        body.view-mode .fs-view { display: block; }
        .fs-view { display: none; position: fixed; inset: 0; background: #000; }
        .fs-view video { width: 100%; height: 100%; object-fit: cover; }
        .fs-exit { position: fixed; top: 8px; right: 8px; z-index: 10001; padding: 6px 12px; background: rgba(0,0,0,0.7); border: 1px solid #666; color: #fff; cursor: pointer; font-size: 11px; opacity: 0.6; }
        .fs-exit:hover { opacity: 1; }
        
        .main-ui { max-width: 1100px; margin: 0 auto; padding: 2rem; }
        h1 { text-align: center; font-size: 1.3rem; font-weight: 300; letter-spacing: 0.15em; margin-bottom: 1rem; }
        .intro { text-align: center; font-size: 0.7rem; opacity: 0.6; line-height: 1.6; margin-bottom: 2rem; max-width: 700px; margin-left: auto; margin-right: auto; }
        .intro a { color: #fff; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem; }
        .box { position: relative; }
        .label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.5; margin-bottom: 0.4rem; }
        .vid-wrap { position: relative; aspect-ratio: 16/9; background: #111; border: 1px solid #333; }
        .vid-wrap video { width: 100%; height: 100%; object-fit: cover; }
        .pop-btn { position: absolute; top: 6px; right: 6px; padding: 4px 8px; font-size: 10px; background: rgba(0,0,0,0.8); border: 1px solid #555; color: #aaa; cursor: pointer; z-index: 10; opacity: 0.7; }
        .pop-btn:hover { opacity: 1; border-color: #fff; color: #fff; }
        .pop-btn:disabled { display: none; }
        
        .btns { display: flex; gap: 0.75rem; margin-top: 0.75rem; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 0.6rem 1.2rem; font-size: 0.85rem; font-weight: 500; background: #111; border: 2px solid #fff; color: #fff; cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; }
        .btn:hover { background: #fff; color: #000; }
        .btn:disabled { opacity: 0.25; cursor: not-allowed; border-color: #555; }
        .btn.on { background: #0a0; border-color: #0a0; color: #fff; }
        
        select.btn { padding: 0.5rem; font-size: 0.75rem; max-width: 180px; }
        
        .controls { background: #111; border: 1px solid #333; padding: 1rem; margin-bottom: 1.5rem; display: flex; gap: 1.5rem; justify-content: center; align-items: center; flex-wrap: wrap; }
        .controls label { font-size: 0.75rem; opacity: 0.7; margin-right: 0.3rem; }
        .controls input[type="range"] { width: 100px; vertical-align: middle; }
        .controls span { font-size: 0.8rem; color: #a8f; min-width: 40px; display: inline-block; }
        
        .sliders { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; background: #0a0a0a; border: 1px solid #222; padding: 1rem; }
        .sl label { display: block; font-size: 0.65rem; opacity: 0.6; margin-bottom: 0.25rem; }
        .sl input { width: 100%; }
        
        #hue::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: hsl(var(--hue), 85%, 55%); border: 2px solid #fff; cursor: pointer; }
        .sl input:not(#hue)::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: hsl(var(--comp), 85%, 55%); border: 2px solid rgba(255,255,255,0.5); cursor: pointer; }
        input[type="range"] { -webkit-appearance: none; background: rgba(255,255,255,0.15); height: 4px; border-radius: 2px; }
        
        .raindrop { position: fixed; border-radius: 50%; pointer-events: none; }
        @keyframes drop { 0%{opacity:0;transform:scale(0.5)} 15%{opacity:1;transform:scale(1)} 85%{opacity:1} 100%{opacity:0;transform:scale(1.1)} }
        
        @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } .sliders { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="fs-view" id="fsLocal"><video id="fsLocalV" autoplay muted playsinline></video></div>
    <div class="fs-view" id="fsRemote"><video id="fsRemoteV" autoplay playsinline></video></div>
    <button class="fs-exit" id="fsExit" style="display:none">✕ EXIT</button>

    <div class="main-ui">
        <h1>THE MIRROR'S ECHO</h1>
        <div class="intro">
            The Mirror's Echo operates as an unlimited edition under open-source principles (AGPL-3.0), ensuring accessibility while sustaining ongoing development. Exhibition licenses and institutional partnerships support the continued evolution of networked digital art practices.<br><br>
            Artist/Technical: <a href="mailto:kristabluedoor@gmail.com">kristabluedoor@gmail.com</a> · Curatorial/Institutional: <a href="mailto:chaoscontemporarycraft@gmail.com">chaoscontemporarycraft@gmail.com</a>
        </div>

        <div class="grid">
            <div class="box">
                <div class="label">Local Camera</div>
                <div class="vid-wrap">
                    <video id="localV" autoplay muted playsinline></video>
                    <button class="pop-btn" id="popL" disabled>↗</button>
                </div>
                <div class="btns">
                    <button class="btn" id="camBtn">START WEBCAM</button>
                    <button class="btn" id="micBtn" disabled>MIC OFF</button>
                </div>
            </div>
            <div class="box">
                <div class="label">Remote Stream (OBS/NDI/Camera)</div>
                <div class="vid-wrap">
                    <video id="remoteV" autoplay playsinline></video>
                    <button class="pop-btn" id="popR" disabled>↗</button>
                </div>
                <div class="btns">
                    <select class="btn" id="remoteCam"><option value="">Select source...</option></select>
                    <button class="btn" id="remoteBtn">START</button>
                    <button class="btn" id="fullBtn" disabled>FULLSCREEN</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div><label>Intensity</label><input type="range" id="int" min="0" max="100" value="0"><span id="intV">0%</span></div>
            <div><label>Speed</label><input type="range" id="spd" min="5" max="30" value="10"><span id="spdV">1.0x</span></div>
        </div>

        <div class="sliders">
            <div class="sl"><label>Hue <span id="hueV">280</span></label><input type="range" id="hue" min="0" max="360" value="280"></div>
            <div class="sl"><label>Saturation <span id="satV">85</span></label><input type="range" id="sat" min="0" max="100" value="85"></div>
            <div class="sl"><label>Size <span id="szV">50</span></label><input type="range" id="sz" min="10" max="120" value="50"></div>
            <div class="sl"><label>Glow <span id="glwV">60</span></label><input type="range" id="glw" min="0" max="100" value="60"></div>
        </div>
    </div>

<script>
const S = {hue:280, sat:85, int:0, sz:50, spd:10, glw:60};
let stream = null;
let remoteStream = null;
let micOn = false;
const startTime = Date.now();
const rainStartTime = 480000; // 8 minutes

function updateColors() {
    document.documentElement.style.setProperty('--hue', S.hue);
    document.documentElement.style.setProperty('--comp', (S.hue + 180) % 360);
}
updateColors();

// URL view mode
const view = new URLSearchParams(location.search).get('view');
if (view === 'local' || view === 'remote') {
    document.body.classList.add('view-mode');
    document.getElementById(view === 'local' ? 'fsLocal' : 'fsRemote').style.display = 'block';
    document.getElementById('fsExit').style.display = 'block';
    if (view === 'local') {
        navigator.mediaDevices.getUserMedia({video:{width:1920,height:1080},audio:false})
            .then(s => { document.getElementById('fsLocalV').srcObject = s; })
            .catch(console.error);
    }
}
document.getElementById('fsExit').onclick = () => { location.href = location.pathname; };

// Populate camera dropdown
async function populateCameras() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const select = document.getElementById('remoteCam');
        // Clear old options except first
        while (select.options.length > 1) select.remove(1);
        devices.filter(d => d.kind === 'videoinput').forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.textContent = d.label || 'Camera ' + (select.options.length);
            select.appendChild(opt);
        });
    } catch(e) { console.error(e); }
}

// START WEBCAM
document.getElementById('camBtn').onclick = async function() {
    this.textContent = 'STARTING...';
    try {
        stream = await navigator.mediaDevices.getUserMedia({video: {width: 1280, height: 720}, audio: true});
        document.getElementById('localV').srcObject = stream;
        stream.getAudioTracks().forEach(t => { t.enabled = false; });
        this.textContent = 'WEBCAM ON';
        this.classList.add('on');
        document.getElementById('popL').disabled = false;
        document.getElementById('micBtn').disabled = false;
        // Populate remote camera dropdown after permission granted
        setTimeout(populateCameras, 500);
    } catch(e) {
        console.error(e);
        this.textContent = 'RETRY';
    }
};

// MIC TOGGLE
document.getElementById('micBtn').onclick = function() {
    if (!stream) return;
    micOn = !micOn;
    stream.getAudioTracks().forEach(t => { t.enabled = micOn; });
    this.textContent = micOn ? 'MIC ON' : 'MIC OFF';
    this.classList.toggle('on', micOn);
};

// REMOTE STREAM START (OBS Virtual Camera, NDI Virtual Input, etc.)
document.getElementById('remoteBtn').onclick = async function() {
    const deviceId = document.getElementById('remoteCam').value;
    this.textContent = 'STARTING...';
    try {
        const constraints = deviceId 
            ? { video: { deviceId: { exact: deviceId }, width: 1280, height: 720 }, audio: false }
            : { video: { width: 1280, height: 720 }, audio: false };
        remoteStream = await navigator.mediaDevices.getUserMedia(constraints);
        document.getElementById('remoteV').srcObject = remoteStream;
        document.getElementById('fsRemoteV').srcObject = remoteStream;
        this.textContent = 'ON';
        this.classList.add('on');
        document.getElementById('popR').disabled = false;
        document.getElementById('fullBtn').disabled = false;
        // Re-populate dropdown with labels now that we have permission
        populateCameras();
    } catch(e) {
        console.error(e);
        this.textContent = 'RETRY';
    }
};

// FULLSCREEN
document.getElementById('fullBtn').onclick = function() {
    const vid = document.getElementById('remoteV');
    if (vid.requestFullscreen) vid.requestFullscreen();
};

// POP OUT BUTTONS
document.getElementById('popL').onclick = () => {
    window.open(location.pathname + '?view=local', '_blank', 'width=1280,height=720');
};
document.getElementById('popR').onclick = () => {
    window.open(location.pathname + '?view=remote', '_blank', 'width=1280,height=720');
};

// INTENSITY & SPEED
document.getElementById('int').oninput = function() {
    S.int = +this.value;
    document.getElementById('intV').textContent = S.int + '%';
};
document.getElementById('spd').oninput = function() {
    S.spd = +this.value;
    document.getElementById('spdV').textContent = (S.spd / 10).toFixed(1) + 'x';
};

// SLIDERS
document.getElementById('hue').oninput = function() {
    S.hue = +this.value;
    document.getElementById('hueV').textContent = S.hue;
    updateColors();
};
document.getElementById('sat').oninput = function() {
    S.sat = +this.value;
    document.getElementById('satV').textContent = S.sat;
};
document.getElementById('sz').oninput = function() {
    S.sz = +this.value;
    document.getElementById('szV').textContent = S.sz;
};
document.getElementById('glw').oninput = function() {
    S.glw = +this.value;
    document.getElementById('glwV').textContent = S.glw;
};

// RAINDROP SPAWNING
function spawnDrop() {
    const d = document.createElement('div');
    d.className = 'raindrop';
    
    // 30% use selected hue, 70% rainbow
    const useHue = Math.random() < 0.30;
    const h = useHue ? S.hue + (Math.random() * 50 - 25) : Math.random() * 360;
    
    const size = S.sz * (0.5 + Math.random());
    const opacity = 0.4 + (S.int / 100) * 0.5;
    const glow = S.glw * 0.8;
    const duration = 4 / (S.spd / 10);
    
    d.style.cssText = `
        left: ${Math.random() * 100}vw;
        top: ${Math.random() * 100}vh;
        width: ${size}px;
        height: ${size}px;
        background: radial-gradient(circle at 30% 30%, 
            hsla(${h}, ${S.sat}%, 75%, ${opacity + 0.2}), 
            hsla(${h}, ${S.sat}%, 55%, ${opacity}), 
            transparent);
        box-shadow: 0 0 ${glow}px hsl(${h}, ${S.sat}%, 60%);
        animation: drop ${duration}s ease-out forwards;
        z-index: ${1000 + Math.floor(Math.random() * 500)};
    `;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), duration * 1000);
}

// ANIMATION LOOP
function loop() {
    const elapsed = Date.now() - startTime;
    
    // Manual intensity spawns drops anytime
    if (S.int > 0) {
        const chance = S.int / 500;
        if (Math.random() < chance) spawnDrop();
    }
    
    // Auto drops only after 8 minutes
    if (elapsed >= rainStartTime) {
        const progress = Math.min((elapsed - rainStartTime) / 120000, 1); // 0-1 over 2 min after 8
        const autoChance = 0.02 + progress * 0.15;
        if (Math.random() < autoChance) spawnDrop();
    }
    
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
