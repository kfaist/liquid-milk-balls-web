<!DOCTYPE html>
<html>
<head>
    <title>üîç Complete System Diagnostic</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #0cf;
            font-family: 'Courier New', monospace;
            padding: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        h1 { color: #0ff; margin-bottom: 20px; font-size: 24px; }
        h2 { color: #0cf; margin: 20px 0 10px 0; font-size: 18px; border-bottom: 1px solid #0cf; padding-bottom: 5px; }
        .test { 
            padding: 15px; 
            margin: 10px 0; 
            border: 1px solid #333;
            border-radius: 4px;
            background: #111;
        }
        .test-name { font-weight: bold; color: #fff; margin-bottom: 8px; }
        .status { 
            display: inline-block;
            padding: 3px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .pass { background: #0f0; color: #000; }
        .fail { background: #f00; color: #fff; }
        .pending { background: #ff0; color: #000; }
        .details { 
            color: #888; 
            font-size: 12px; 
            margin-top: 8px;
            padding: 8px;
            background: #000;
            border-left: 3px solid #0cf;
        }
        .code { 
            background: #000; 
            padding: 10px; 
            border-radius: 3px;
            overflow-x: auto;
            font-size: 12px;
            margin: 8px 0;
        }
        .summary {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #111;
            border: 2px solid #0cf;
            padding: 15px;
            border-radius: 4px;
            min-width: 200px;
        }
        .summary h3 { margin-bottom: 10px; color: #0ff; }
        .count { font-size: 20px; font-weight: bold; }
        .timestamp { color: #666; font-size: 11px; margin-top: 10px; }
        #liveStatus { 
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #111;
            border: 2px solid #0cf;
            padding: 15px;
            border-radius: 4px;
            max-width: 300px;
        }
        #liveStatus h4 { color: #0ff; margin-bottom: 8px; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <h1>üîç COMPLETE PIPELINE DIAGNOSTIC</h1>
    
    <div class="summary" id="summary">
        <h3>Test Results</h3>
        <div>‚úÖ Passed: <span class="count" id="passCount">0</span></div>
        <div>‚ùå Failed: <span class="count" id="failCount">0</span></div>
        <div>‚è≥ Pending: <span class="count" id="pendingCount">6</span></div>
        <div class="timestamp" id="timestamp"></div>
    </div>

    <div id="liveStatus">
        <h4>üé• OBS Stream Status</h4>
        <div id="obsStatus" class="pulse">Checking...</div>
    </div>

    <div id="tests"></div>

    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
    <script>
        const tests = [];
        let passCount = 0;
        let failCount = 0;
        let pendingCount = 6;

        function addTest(name, status, details) {
            const test = { name, status, details, timestamp: new Date() };
            tests.push(test);
            renderTests();
            updateCounts();
        }

        function updateCounts() {
            passCount = tests.filter(t => t.status === 'pass').length;
            failCount = tests.filter(t => t.status === 'fail').length;
            pendingCount = 6 - passCount - failCount;
            
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('timestamp').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        }

        function renderTests() {
            const container = document.getElementById('tests');
            container.innerHTML = tests.map(test => `
                <div class="test">
                    <div class="test-name">${test.name}</div>
                    <span class="status ${test.status}">${
                        test.status === 'pass' ? '‚úÖ PASS' : 
                        test.status === 'fail' ? '‚ùå FAIL' : 
                        '‚è≥ PENDING'
                    }</span>
                    <div class="details">${test.details}</div>
                </div>
            `).join('');
        }

        async function runAllTests() {
            // Test 1: LiveKit SDK Loading
            setTimeout(() => {
                if (typeof LivekitClient !== 'undefined') {
                    addTest(
                        'Test 1: LiveKit SDK Loading',
                        'pass',
                        `‚úÖ LivekitClient object loaded successfully<br>
                        Version: ${LivekitClient.version || 'unknown'}<br>
                        Room class: ${typeof LivekitClient.Room}<br>
                        Track class: ${typeof LivekitClient.Track}<br>
                        CDN: https://cdn.jsdelivr.net/npm/livekit-client/`
                    );
                } else {
                    addTest(
                        'Test 1: LiveKit SDK Loading',
                        'fail',
                        '‚ùå LivekitClient is not defined. SDK failed to load from CDN.'
                    );
                }
            }, 1000);

            // Test 2: API Token Endpoint
            try {
                const response = await fetch('/api/processed-publisher-token');
                const data = await response.json();
                
                if (data.token && data.url && data.whipUrl) {
                    addTest(
                        'Test 2: WHIP Token Generation',
                        'pass',
                        `‚úÖ Token endpoint working<br>
                        Room: ${data.room}<br>
                        LiveKit URL: ${data.url}<br>
                        WHIP URL length: ${data.whipUrl.length} chars<br>
                        Token expires: ~24 hours`
                    );
                } else {
                    addTest(
                        'Test 2: WHIP Token Generation',
                        'fail',
                        `‚ùå Token response incomplete: ${JSON.stringify(data)}`
                    );
                }
            } catch (error) {
                addTest(
                    'Test 2: WHIP Token Generation',
                    'fail',
                    `‚ùå Failed to fetch token: ${error.message}`
                );
            }

            // Test 3: Viewer Token Endpoint
            try {
                const response = await fetch('/api/processed-viewer-token');
                const data = await response.json();
                
                if (data.token && data.url && data.room) {
                    addTest(
                        'Test 3: Viewer Token Generation',
                        'pass',
                        `‚úÖ Viewer token endpoint working<br>
                        Room: ${data.room}<br>
                        Can subscribe: true<br>
                        Can publish: false (correct for viewer)`
                    );
                } else {
                    addTest(
                        'Test 3: Viewer Token Generation',
                        'fail',
                        `‚ùå Viewer token incomplete: ${JSON.stringify(data)}`
                    );
                }
            } catch (error) {
                addTest(
                    'Test 3: Viewer Token Generation',
                    'fail',
                    `‚ùå Failed to fetch viewer token: ${error.message}`
                );
            }

            // Test 4: LiveKit Connection Test
            if (typeof LivekitClient !== 'undefined') {
                try {
                    const response = await fetch('/api/processed-viewer-token');
                    const data = await response.json();
                    
                    const room = new LivekitClient.Room();
                    
                    room.on(LivekitClient.RoomEvent.Connected, () => {
                        addTest(
                            'Test 4: LiveKit Server Connection',
                            'pass',
                            `‚úÖ Successfully connected to LiveKit room<br>
                            Room: ${data.room}<br>
                            Server: ${data.url}<br>
                            Status: Connected and ready`
                        );
                        room.disconnect();
                    });

                    room.on(LivekitClient.RoomEvent.Disconnected, () => {
                        console.log('Disconnected from test connection');
                    });

                    await Promise.race([
                        room.connect(data.url, data.token),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Connection timeout')), 10000))
                    ]);

                } catch (error) {
                    addTest(
                        'Test 4: LiveKit Server Connection',
                        'fail',
                        `‚ùå Could not connect to LiveKit: ${error.message}<br>
                        This might be normal if no one is streaming yet.`
                    );
                }
            } else {
                addTest(
                    'Test 4: LiveKit Server Connection',
                    'fail',
                    '‚ùå Skipped - LiveKit SDK not loaded'
                );
            }

            // Test 5: OBS Stream Detection
            monitorOBSStream();

            // Test 6: Complete Pipeline Check
            setTimeout(() => {
                const allPassed = passCount >= 4;
                addTest(
                    'Test 6: Overall System Health',
                    allPassed ? 'pass' : 'fail',
                    allPassed ? 
                        '‚úÖ System is ready to stream!<br>OBS can stream ‚Üí LiveKit ‚Üí Viewers can watch' :
                        `‚ùå System has issues. Check failed tests above.<br>
                        Passed: ${passCount}/6 tests`
                );
            }, 12000);
        }

        async function monitorOBSStream() {
            // We can't directly detect if OBS is streaming, but we can check if there's active video in the room
            if (typeof LivekitClient === 'undefined') {
                addTest(
                    'Test 5: OBS Stream Detection',
                    'fail',
                    '‚ùå Cannot check - LiveKit SDK not loaded'
                );
                return;
            }

            try {
                const response = await fetch('/api/processed-viewer-token');
                const data = await response.json();
                
                const room = new LivekitClient.Room();
                let foundVideo = false;

                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {
                    if (track.kind === LivekitClient.Track.Kind.Video) {
                        foundVideo = true;
                        document.getElementById('obsStatus').textContent = '‚úÖ OBS is streaming!';
                        document.getElementById('obsStatus').className = '';
                        addTest(
                            'Test 5: OBS Stream Detection',
                            'pass',
                            '‚úÖ Active video stream detected in processed-output room!<br>OBS is successfully streaming.'
                        );
                        room.disconnect();
                    }
                });

                await room.connect(data.url, data.token);

                setTimeout(() => {
                    if (!foundVideo) {
                        document.getElementById('obsStatus').textContent = '‚ö†Ô∏è No stream detected (OBS not streaming yet)';
                        document.getElementById('obsStatus').className = '';
                        addTest(
                            'Test 5: OBS Stream Detection',
                            'fail',
                            '‚ö†Ô∏è No active video stream found.<br>This means OBS is not currently streaming.<br>Start streaming in OBS to complete the pipeline!'
                        );
                    }
                    room.disconnect();
                }, 8000);

            } catch (error) {
                document.getElementById('obsStatus').textContent = '‚ùå Error checking stream';
                addTest(
                    'Test 5: OBS Stream Detection',
                    'fail',
                    `‚ùå Error: ${error.message}`
                );
            }
        }

        // Start all tests
        runAllTests();
    </script>
</body>
</html>
